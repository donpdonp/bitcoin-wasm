#!/usr/bin/env perl6

use v6;
use lib './lib';
use btcproto;
use btcproto::net;

sub MAIN ( Str $host =  "seed.bitcoin.sipa.be" ) {

  my $supplier = Supplier.new;
  my $supply = $supplier.Supply;
  my $payload_tube = Channel.new;
  my $socket;

  say "connecting $host";
  IO::Socket::Async.connect($host, 8333).then( -> $promise {
    CATCH { default { say .^name, ': ', .Str } };
    $socket = $promise.result;
    $supplier.emit('connect');
    btcproto::net::read_loop($socket, $supplier, $payload_tube);
  });

  $supply.tap( -> $inmsg {
    btcproto::net::dispatch($inmsg, $socket, $payload_tube)
  });

  Channel.new.receive; # wait forever
}

=begin pod
=head1 USAGE
btcproto
=end pod

